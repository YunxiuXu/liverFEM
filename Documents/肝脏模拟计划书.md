# 研究计划：基于分组共旋有限元的高保真肝脏手术实时仿真
## 完整执行方案（2024 修订版）

./build.sh
cd /Users/yunxiuxu/Documents/tetfemcpp && ./run.sh       


'/Users/yunxiuxu/Documents/tetfemcpp/xpbd_run_latest_tetgenfem.sh'

./vegafem_build_and_run.sh cubeLong1300
# 或
./vegafem_build_and_run.sh liver_HD_Low
---

## 📋 论文定位

**题目（暂定）**：
- **中文**：面向虚拟手术的各向异性肝脏实时仿真：一种基于 CPU 的分组有限元方法
- **英文**：Real-Time Simulation of Anisotropic Liver Deformation using Group-Based Corotational FEM on Multi-Core CPUs

**核心特性（Key Features）**：
1.  **CPU 上的实时性**：在消费级 CPU 上实现 20k 四面体肝脏模型的 60 FPS 仿真，无需 GPU，降低硬件要求。
2.  **更好的精度（Better Accuracy）**：通过分组策略保留物理特性，在大变形下的精度优于传统的 XPBD 方法。
3.  **复杂本构支持**：支持各向异性（Anisotropy）和近不可压缩（Incompressibility, ν→0.5）材料，解决现有实时方法在这些医疗特性上的不足。

---

## 📅 第一阶段：代码准备 ✅ **已完成**

**状态**：所有必要的代码功能已就绪（各向异性切换、力录制、自动化测试）。可以直接进入实验阶段。

---

## 📅 第二阶段：实验数据采集（1-2 周）

**目标**：运行四个实验，获取数据（表格、曲线、截图）。

### 🛠️ 对比方法与参数设置 (Baseline Configuration)

为了验证本方法的精度与物理真实性，我们选取了行业标准的 **VegaFEM** 作为离线高精度基准（Ground Truth），以及目前主流的实时物理引擎 **XPBD**（基于 PositionBasedDynamics 库）作为实时竞品进行对比。具体设置如下：

#### 1. VegaFEM (Ground Truth)
作为物理正确性的黄金标准，用于生成各实验的参考真值。
*   **求解器 (Solver)**: Implicit Backward Euler (隐式后向欧拉) 配合 Static Solving 模式，消除动力学震荡，获取准静态下的精确平衡位置。
*   **线性求解器 (Linear Solver)**: Conjugate Gradient (CG) 方法，残差容差 (Residual Tolerance) 设置为 $10^{-9}$，确保数值解收敛至机器精度。
*   **本构模型 (Constitutive Model)**: Corotational Linear FEM (与本方法一致)，确保材质定义的对齐。
*   **网格 (Mesh)**: 使用与实时组完全一致的四面体网格，避免离散化误差。

#### 2. XPBD (Real-Time Competitor)
由于 XPBD 在增加迭代次数时极易导致数值不稳定（爆炸），我们采用了符合物理引擎设计原则的**子步 (Substeps)** 对比方案。
*   **算法 (Method)**: XPBD (Extended Position Based Dynamics)，启用 FEM-based Constraints。
*   **对比策略**：固定迭代次数为 **1**（最稳定），通过调整子步数对比性能与精度。
*   **配置参数**:
    *   **Fast (实时预算)**: Substeps = 5 (模拟 60 FPS 预算)
    *   **Reference (收敛参考)**: Substeps = 50 (模拟收敛解)
    *   **Young's Modulus**: **1,000,000 Pa (1 MPa)** (与 TetgenFEM 和 VegaFEM 完全对齐，确保所有方法模拟相同的物理材料属性)
    *   **Poisson Ratio**: 0.28 (与本方法对齐)

---

### 🔬 实验 1：大变形下的精度验证（Accuracy under Large Deformation）

**目的**：**定量证明**在手术牵拉（大变形）场景下，GB-cFEM 在实时迭代次数下能达到接近收敛解的高保真度，且在 CPU 性能表现上远超需要高子步数才能收敛的 XPBD。

**操作步骤**：
1.  **自动化扫频**：点击 "Start Exp1" 按钮，自动遍历拉力（800, 1500, 2000）和子步数（5, 50）。
2.  **数据采集**：记录所有节点的均方根误差（RMSE）、位移值以及单帧计算耗时（avgStepTime）。

**最新结果对比（实测数据分析）**：
- **性能优势（铁证）**：
    - **XPBD**：达到参考精度（50子步）时，单帧耗时高达 **64.9ms**（仅 **15 FPS**），严重卡顿，无法用于实时交互。
    - **GB-cFEM (Ours)**：在 30 次迭代下仅需约 **12ms** (10线程并行)，帧率维持在 **>60 FPS**，性能领先 **5.4 倍**。
- **精度优势（修正后的发现）**：
    - **物理正确性**：即便在 50 子步的高精度模式下，XPBD 产生的位移（1.57）依然比 FEM 真值（1.19）**偏大了 32%**。这证明 XPBD 存在严重的非物理过度拉伸现象。
    - **相对误差**：在设置了相同的物理杨氏模量（$E = 1,000,000$ Pa）后，XPBD 在低子步下的不收敛性被放大，收敛误差显著高于我们的方法。
- **结论**：实验证明，我们的方法在保持高实时性（>60 FPS）的前提下，不仅收敛速度快，且能保持正确的物理刚度，在捕捉大变形生物力学特性方面优于 XPBD。

**产出**：
- **Figure 3**：Ours vs XPBD 误差分布直方图。
- **Table 1**：不同拉力下的位移误差、FPS 以及单帧耗时对比表。

---

### 🔬 实验 2：不可压缩稳定性（Volume Preservation）

**目的**：证明在 ν→0.5（模拟充血组织）时，本方法能保持严格的体积守恒，克服传统 PBD 方法的体积丢失问题。

**操作步骤**：
1.  **对比设置**：
    - **Baseline**：$\nu=0.28$（普通可压缩组织）。
    - **Incompressible**：$\nu=0.47$（模拟肝脏/充血组织）。
2.  **实验流程**：进行大幅度拖拽，记录随时间变化的总体积比率 $V/V_0$。

**结果分析（基于实测数据）**：
- **Baseline ($\nu=0.28$)**：体积随拉伸自然增加（最大 +0.45%），符合物理规律。
- **Incompressible ($\nu=0.47$)**：体积变化率被显著抑制，曲线更平稳。
- **结论**：算法通过在能量函数中直接引入体积惩罚项（$\log J$），天然支持近不可压缩材料。相比于需要额外编写体积约束且容易不稳定的 XPBD，本方法在模拟类水（Water-like）生物组织时具有显著的**稳定性（Stability）**优势。

**产出**：
- **Figure 4**：两种泊松比下的体积变化曲线对比图。

---

### 🔬 实验 3：各向异性本构验证（Anisotropic Validation）

**目的**：**验证**算法能否正确响应各向异性的物理参数设置，并对比 XPBD 难以精确映射物理参数的劣势。这不是为了发现"横竖拉不一样"的现象，而是为了证明方法在**物理准确性（Physical Accuracy）**上的优势。

**为什么这个实验很重要？**
现有实时方法（如 XPBD）难以将医学测量的各向异性参数（如 $E_x, E_y$）直接映射到其约束刚度中，通常只能通过试错法（Tuning）来模拟。而本 FEM 方法直接基于物理本构。证明这一点是实现**患者特异性（Patient-Specific）**手术模拟的前提——即未来可以直接导入 DTI 医学影像数据来驱动模拟。

**操作步骤**：
1.  **参数设置**： 
    - 设置 $E_x = 5E_y$（模拟沿 X 轴的纤维增强）。
2.  **实验流程**：
    - 沿 X 轴（硬轴）拖拽一定距离，记录反力。
    - 沿 Y 轴（软轴）拖拽相同距离，记录反力。
3.  **数据处理**：
    - 生成力-位移曲线，计算刚度比值。

**产出**：
- **Figure 5**：两条斜率明显不同的力-位移曲线。
- **结论**：定量数据显示硬轴/软轴刚度比约为 3.4 倍（在 $E_x/E_y=5$ 的输入下），证明求解器能正确反映物理参数输入。相比于参数调节困难的 XPBD，本方法能提供更**准确（Accurate）**的生物力学响应。

---

### 🔬 实验 4：性能分析（Performance Evaluation）

**目的**：定量评估基于 CPU 的分组并行方案在不同网格规模下的实时性能（FPS）和可扩展性（Scalability）。

**操作步骤**：
1.  **场景设置**：使用三个不同分辨率的肝脏网格（Low: ~5k, Mid: ~20k, High: ~50k 四面体）。
2.  **变量控制**：分别在单线程（1 Thread）和多线程（10 Threads）环境下运行仿真。
3.  **指标采集**：记录稳定运行时的平均帧率（FPS）和加速比（Speedup）。

**结果分析（基于实测数据）**：
- **中等规模（20k tets，典型手术模拟精度）**：
    - 单线程：16 FPS（卡顿）。
    - 多线程：**81 FPS**（流畅实时）。
    - **加速比：5.0x**。
- **结论**：实验证明，该方法能够在保持高精度（20k 四面体）的同时，仅利用消费级 CPU 实现 >60 FPS 的流畅交互。这验证了"分组并行（Group-Based Parallelism）"策略在消除数据竞争和利用多核性能方面的高效性。

**产出**：
- **Table 2**：不同规模与线程数下的 FPS 及加速比统计表。

---

## 🎬 视频制作要求（针对 I3D/CAG 等会议投稿）

**重要性**：根据 CAG 和 Eurographics 的审稿反馈，**高质量的视频演示是论文被接受的关键因素之一**。审稿人明确要求看到"实时对比"和"相位一致性"的视觉证据。

### 视频内容要求

#### 1. **Split-Screen 实时对比（核心要求）**
- **布局**：左右分屏，左侧显示 **GB-cFEM (Ours)**，右侧显示 **XPBD**
- **同步播放**：两个方法必须使用**完全相同的输入力序列**，确保对比的公平性
- **场景**：肝脏模型在相同外力作用下的变形过程
- **时长**：每个对比片段 15-30 秒，展示完整的变形-恢复周期

#### 2. **体积可视化（Volume Visualization）**
- **颜色映射**：
  - **红色** = 体积膨胀（volume_ratio > 1.0）
  - **蓝色** = 体积收缩（volume_ratio < 1.0）
  - **绿色/白色** = 体积守恒（volume_ratio ≈ 1.0）
- **目的**：直观展示 GB-cFEM 在体积保持上的优势（更接近绿色/白色）
- **实现**：在渲染时根据每个四面体的体积变化率进行颜色插值

#### 3. **实时性能指标显示**
- **FPS 计数器**：在画面左上角或右上角实时显示当前帧率
- **迭代次数/子步数**：显示当前使用的求解强度（如 "Iterations: 10" 或 "Substeps: 10"）
- **体积误差百分比**：实时显示当前体积偏差（如 "Volume Error: 1.35%"）

#### 4. **相位一致性验证（Phase Consistency）**
- **问题背景**：CAG Reviewer #2 质疑："Why does the video only show fixed frames? I want to see if they remain in phase."
- **解决方案**：
  - 录制**完整的动态过程**，而非静态截图
  - 在视频中标注关键时间点（如 "t=0.5s: Maximum Deformation"）
  - 展示两个方法在相同时间点的同步状态，证明它们响应的是同一物理输入

#### 5. **多场景覆盖**
- **场景 1：实验 1（大变形精度）**
  - 展示肝脏在牵拉作用下的变形
  - 重点：GB-cFEM 的变形轨迹更接近 VegaFEM Ground Truth
- **场景 2：实验 2（体积守恒）**
  - 展示在近不可压缩（ν=0.47）下的拉伸过程
  - 重点：GB-cFEM 的体积颜色更稳定（更少红色/蓝色波动）
- **场景 3：实验 4（实时性能）**
  - 展示交互式拖拽操作
  - 重点：FPS 计数器始终显示 >60 FPS

### 技术规格要求

- **分辨率**：至少 1920×1080 (Full HD)，推荐 2560×1440 (2K)
- **帧率**：60 FPS（与模拟帧率对齐）
- **格式**：MP4 (H.264 编码)
- **时长**：总时长 3-4 分钟，包含：
  - 开场介绍（10-15 秒）：展示肝脏模型和实验设置
  - 核心对比（2-3 分钟）：Split-screen 实时对比
  - 性能展示（30-45 秒）：FPS 和体积误差的实时监控
  - 结尾总结（10-15 秒）：关键数据摘要

### 视频制作工具建议

- **录制软件**：OBS Studio（免费，支持多窗口录制）
- **后期编辑**：DaVinci Resolve（免费）或 Adobe Premiere Pro
- **标注工具**：在视频中添加文字说明、箭头指示关键区域

### 视频提交检查清单

- [ ] Split-screen 对比清晰可见
- [ ] 体积颜色映射正常工作
- [ ] FPS 计数器实时更新
- [ ] 两个方法使用相同的输入序列
- [ ] 视频流畅，无卡顿或掉帧
- [ ] 关键数据（FPS、体积误差）在画面中清晰可见
- [ ] 视频总时长控制在 4 分钟以内

---

## 📅 第三阶段：论文撰写（2 周）

### Section 1: Introduction
- **背景**：手术模拟需要实时且物理真实。
- **问题**：现有方法要么慢（传统 FEM），要么物理不准（PBD/XPBD 在各向异性和体积守恒上的缺陷）。GPU 方案成本高。
- **贡献**：
    1.  提出基于分组的 CPU 并行 FEM 框架。
    2.  集成各向异性本构，提高医疗仿真的物理逼真度。
    3.  验证了在大变形和近不可压缩情况下的稳定性。

### Section 2: Methodology
- **Group-Based Acceleration**：解释如何通过分组减少数据竞争，利用 CPU 多核。
- **Anisotropic Constitutive Model**：列出各向异性刚度矩阵的公式。
- **Implicit Integration**：简述求解过程。

### Section 3: Experiments and Results
- **3.1 Setup**：实验平台与参数。
- **3.2 Accuracy**：展示实验 1 结果（牵拉实验）。强调在大变形下比 XPBD 更准。
- **3.3 Stability**：展示实验 2 结果（体积守恒）。
- **3.4 Anisotropy**：展示实验 3 结果（力反馈差异）。
- **3.5 Performance**：展示实验 4 结果（FPS）。

### Section 4: Discussion & Conclusion
- **总结**：该方法提供了一个**平衡的（Balanced）**解决方案：在 CPU 上实现了足够的实时性，同时保留了必要的物理精度。
- **局限**：未处理拓扑改变（切割）。
- **未来工作**：结合医学影像（DTI）数据导入真实纤维方向。

---

## 🚀 当前任务清单

1.  **[实验 3] 各向异性测试**（最快）：
    - 运行程序，分别在各向异性和同性参数下，用 `X`/`Y` 键自动测试并保存数据。
    - 用 Python 画图。
2.  **[实验 2] 体积守恒测试**：
    - 设 `poisson=0.49`，手动大变形拖拽，观察是否稳定。
3.  **[实验 1] 精度测试**（需要花点时间）：
    - 思考如何获取 Ground Truth 数据（是否有 VegaFEM 安装？或者引用标准数据？）。如果没有 VegaFEM，可以考虑用高分辨率的离线 FEM 结果作为参考。
