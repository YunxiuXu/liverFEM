# 研究计划：基于分组共旋有限元的高保真肝脏手术实时仿真
## 完整执行方案（2024 版）

---

## 📋 论文定位

**题目（暂定）**：
- **中文**：面向虚拟手术的各向异性肝脏实时仿真：一种基于 CPU 的高保真分组有限元方法
- **英文**：Real-Time High-Fidelity Simulation of Anisotropic Liver Deformation using Group-Based Corotational FEM on Multi-Core CPUs

**核心卖点（Highlights）**：
1. **CPU 上的实时性**：在普通消费级 CPU 上实现 20k 四面体肝脏模型的 60 FPS 仿真，无需昂贵 GPU，降低医疗模拟器门槛。
2. **优于 VBD 的精度**：通过分组策略保留更多物理真实性，在大变形和复杂几何体（肝脏）下的精度优于当前流行的 VBD 方法（已有前期论文支撑）。
3. **复杂本构支持**：原生支持各向异性（Anisotropy）和近不可压缩（Incompressibility, ν→0.5）材料，解决了 XPBD/PBD 在这些医疗关键特性上的痛点。

**投稿目标**：
- 中等偏上会议/期刊（如 MICCAI, CASA, CMBBE, CGI 等）
- 周期：3-6 个月（从现在到接收）

---

## 📅 第一阶段：代码准备 ✅ **已完成**

**目标**：让代码支持各向异性、力录制、自动化测试。

### ✅ 已完成的功能
1. **各向异性自动切换**：代码检测 `youngs1/2/3` 参数，自动选择各向异性/各向同性刚度矩阵。
2. **力录制**：按 `R` 开始录制，按 `S` 保存到 `force_data.txt`。
3. **自动化测试**：
   - 按 `X` 键：自动沿 X 轴拖拽，生成 `force_data_x.txt`。
   - 按 `Y` 键：自动沿 Y 轴拖拽，生成 `force_data_y.txt`。
4. **肝门固定**：代码中已有 `fixRegion(center, radius)` 函数。

**状态**：所有必要的代码功能已就绪。可以直接进入实验阶段。

---

## 📅 第二阶段：实验数据采集（1-2 周）

**目标**：运行四个完整实验，拿到所有论文素材（表格、曲线、截图）。

---

### 🔬 实验 1：精度与鲁棒性对比（The "Better than VBD" Experiment）

**目标**：证明 GB-cFEM 的形变精度优于 VBD/XPBD（或接近 Ground Truth）。

**对手**：
- **Baseline 1**：XPBD（如果有现成实现）
- **Baseline 2**：VBD（引用已发表数据，或跑 VBD 代码）
- **Ground Truth**：VegaFEM 离线求解器（高精度参考）

**操作步骤**：
1. **场景设置**：
   - 固定肝门（使用 `fixRegion`）。
   - 施加重力（`gravity = -9.8`）。
   - （可选）在某一点施加恒定外力。
2. **运行三种方法**：
   - GB-cFEM（你的方法）
   - XPBD/VBD（如有）
   - VegaFEM（离线，作为参考）
3. **数据采集**：
   - 记录平衡状态下所有节点的坐标。
   - 计算 RMSE：$\text{RMSE} = \sqrt{\frac{1}{N}\sum_{i=1}^{N} \| \mathbf{p}_i^{\text{method}} - \mathbf{p}_i^{\text{GT}} \|^2}$

**产出**：
- **Table 1**：精度对比表
  | Method | RMSE (mm) | Max Error (mm) | Time per Frame (ms) |
  |--------|-----------|----------------|---------------------|
  | GB-cFEM | ? | ? | ? |
  | XPBD | ? | ? | ? |
  | VBD (引用) | ~X.X | ~X.X | ~X.X |
  | VegaFEM (GT) | 0 | 0 | >1000 |

- **Figure 3**：三种方法的变形可视化重叠图（用 Heatmap 显示误差分布）。

**重要性**：★★★★☆（如果没有 VBD/XPBD 实现，可以只跟 Ground Truth 比，然后引用前期论文中的 VBD 数据）

---

### 🔬 实验 2：不可压缩稳定性（The "Killer Feature" Experiment）

**目标**：证明 ν→0.5 时体积守恒优于 XPBD，且不会爆炸。

**操作步骤**：
1. **参数设置**：
   - `parameters.txt` 中 `poisson=0.49`（模拟充血肝脏）。
2. **实验流程**：
   - 运行模拟。
   - 用鼠标大幅度拉伸/按压肝脏。
   - 每帧计算总体积：$V(t) = \sum_{\text{tetra}} V_{\text{tetra}}(t)$
   - 记录体积变化率：$\Delta V / V_0$
3. **对比 XPBD**（如有）：
   - XPBD 在 ν=0.49 时体积会剧烈波动或丢失。

**产出**：
- **Figure 4**：
  - 左图：截图展示大变形时的稳定状态（标注 ν=0.49）。
  - 右图：体积变化曲线（X 轴=时间，Y 轴=ΔV/V₀）。GB-cFEM 应保持在 ±1% 内，XPBD 曲线会发散。

**重要性**：★★★★★（这是医疗仿真的核心需求，XPBD 的软肋）

---

### 🔬 实验 3：各向异性与触觉反馈（The "Medical Application" Experiment）- **已有初步数据**

**目标**：展示沿不同方向拖拽时，反力明显不同（XPBD 做不到）。

**操作步骤**：
1. **参数设置**：
   ```
   youngs1 5000000.0   # 硬轴（如 X 轴）
   youngs2 1000000.0   # 软轴（如 Y 轴）
   youngs3 1000000.0
   ```
2. **实验流程**：
   - 按 `R` 开始录制。
   - 沿 X 轴拖拽肝脏（硬方向）。
   - 按 `S` 保存为 `force_hard.txt`。
   - 重复上述步骤，沿 Y 轴拖拽，保存为 `force_soft.txt`。
3. **数据处理**：
   - 运行 `python3 plot_anisotropy.py` 生成对比曲线。

**产出**：
- **Figure 5**：
  - 左图：两张截图（硬轴 vs 软轴的变形对比）。
  - 右图：力-时间曲线对比（已有数据，峰值比 ~21x）。
  - 图注："The reaction force in the stiff axis is approximately 21× higher than in the soft axis, demonstrating the algorithm's capability to simulate directionally dependent tissue response necessary for patient-specific surgical training."

**重要性**：★★★★★（这是你的独特卖点，XPBD/VBD 很难做到真实的各向异性）

---

### 🔬 实验 4：性能分析（The "Real-time" Experiment）

**目标**：证明 CPU 方案在不同规模下的实时性。

**操作步骤**：
1. **调整模型规模**：
   - 修改 `parameters.txt` 中的 `groupNumX/Y/Z` 或使用不同分辨率的肝脏模型。
   - 记录控制台输出的四面体总数。
2. **记录 FPS**：
   - 运行模拟 30 秒，记录平均 FPS。
   - （可选）测试不同 OpenMP 线程数（如 4, 8, 16 线程）。
3. **对比数据**：
   - 如果有 VBD 实现，记录其 GPU 上的 FPS。
   - 如果没有，引用已发表论文的数据。

**产出**：
- **Table 2**：性能对比表
  | Model Size (Tetras) | GB-cFEM (CPU, 8 threads) | Traditional FEM (CPU) | VBD (GPU, 引用) |
  |---------------------|--------------------------|------------------------|-----------------|
  | ~5k | ? FPS | ? FPS | ~XXX FPS |
  | ~20k | ~60 FPS | ~10 FPS | ~XXX FPS |
  | ~50k | ? FPS | <5 FPS | ~XXX FPS |

- **Figure 6**：FPS vs 四面体数曲线图。

**重要性**：★★★☆☆（次要，但能展示实用性）

---

## 📅 第三阶段：论文撰写（2 周）

**目标**：填空式写作。

---

### Section 1: Introduction

**内容框架**：
1. **医疗背景**：手术模拟需要实时 + 物理真实（引用 2-3 篇 MICCAI/MedIA）。
2. **现有方法的困境**：
   - **传统 FEM**：准但慢（引用 VegaFEM）。
   - **XPBD/PBD**：快但物理打折（体积丢失、参数不可解释，引用 XPBD 原文）。
   - **VBD**：快且较准，但需要 GPU，且在各向异性支持上有限（引用你前期论文）。
3. **你的解法**：GB-cFEM（简要描述）。
4. **Contributions**：
   - 提出基于分组的旋转刚度提取加速方法。
   - 原生支持各向异性和近不可压缩材料。
   - 在消费级 CPU 上实现实时大变形肝脏模拟。

---

### Section 2: Methodology

**内容框架**：
1. **Linear Corotated FEM 回顾**（复用前期工作，精简）。
2. **Group-Based Acceleration**（算法核心，贴伪代码）。
3. **Anisotropic Stiffness Matrix**（重点）：
   - 推导正交各向异性本构关系。
   - 给出刚度矩阵公式（即使代码用 Eigen，公式要写漂亮）。
4. **Boundary Conditions for Liver**：
   - 描述肝门固定策略（`fixRegion`）。
5. **Implementation Details**：
   - OpenMP 并行。
   - 直接求解器（Eigen SimplicialLDLT）。

---

### Section 3: Experiments and Results

**内容框架**：

#### 3.1 Experimental Setup
- **Model**：Liver (20k tetras, generated from NII medical data via TetGen)。
- **Platform**：Intel i7-XXXX, 8 cores, 16 GB RAM, no GPU。
- **Parameters**：E=1.0 MPa, ν=0.45 (default), density=1000 kg/m³。

#### 3.2 Accuracy and Robustness (Experiment 1)
- 贴 **Table 1** 和 **Figure 3**。
- 描述：GB-cFEM 的 RMSE 明显低于 XPBD，接近 Ground Truth。

#### 3.3 Volume Preservation under Near-Incompressibility (Experiment 2)
- 贴 **Figure 4**。
- 描述：ν=0.49 时，体积变化 <1%，而 XPBD 体积丢失 >10%。

#### 3.4 Anisotropic Haptic Feedback (Experiment 3)
- 贴 **Figure 5**。
- 描述：反力比 ~21x，证明算法能区分组织方向性。
- **关键句**："This directional dependence is necessary for simulating pathological conditions such as fibrotic liver tissue, where stiffness varies along fiber orientations."

#### 3.5 Performance Analysis (Experiment 4)
- 贴 **Table 2** 和 **Figure 6**。
- 描述：20k 模型在 CPU 上达到 60 FPS，满足实时交互需求。

---

### Section 4: Discussion

**内容框架**：
1. **优势**：
   - CPU 方案降低硬件门槛（无需昂贵 GPU）。
   - 真实物理响应（体积守恒、各向异性）。
2. **局限**：
   - 没有真实纤维数据（但算法已就绪，可与 DTI 结合）。
   - 未实现切割（Future Work）。
3. **应用场景**：
   - 虚拟手术训练。
   - 术前规划（patient-specific modeling）。

---

### Section 5: Conclusion

**内容框架**：
- 总结三个 Contributions。
- 强调 CPU 实时 + 物理真实 + 各向异性支持。
- Future Work：加入切割、与 DTI 数据结合、GPU 加速。

---

## 🚀 当前首要任务清单（按优先级）

### ⚡ 紧急（本周完成）

- [ ] **Task A**：恢复 `main.cpp` 的各向异性开关和力录制功能（或告诉我是否需要帮助）。
- [ ] **Task B**：运行 `python3 plot_anisotropy.py` 生成各向异性对比图（Figure 5）。
- [ ] **Task C**：完成实验 2（不可压缩稳定性），截图并记录体积变化（Figure 4）。

### 📊 重要（下周完成）

- [ ] **Task D**：完成实验 4（性能分析），记录不同规模下的 FPS（Table 2）。
- [ ] **Task E**：（可选）如果有 XPBD/VBD 代码，跑实验 1（精度对比）。

### 📝 次要（两周后）

- [ ] **Task F**：开始论文撰写（Introduction + Methodology）。
- [ ] **Task G**：填充实验数据到论文（Results）。

---

## 📌 重要提醒

1. **关于各向异性的"生物民科"问题**：
   - 不要声称"模拟了真实肝脏纤维"。
   - 而是说："Our method demonstrates the *capability* to handle anisotropic materials, which is necessary for future integration with patient-specific fiber data (e.g., from DTI) or for simulating pathological conditions like fibrotic tissue."

2. **关于与 VBD 的比较**：
   - 你的前期论文已经证明精度优于 VBD。
   - 这次论文重点强调：**各向异性 + CPU 实时 + 体积守恒** 是你的优势。

3. **关于投稿目标**：
   - 如果追求速度：投 CASA, CGI（接收率较高）。
   - 如果追求影响力：投 MICCAI, CMBBE（周期长但认可度高）。

---

**下一步行动**：请告诉我你是否需要帮助恢复 `main.cpp` 的代码，或者直接开始做实验 2（不可压缩稳定性测试）。
